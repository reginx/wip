(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver(t=>{for(const n of t)if(n.type==="childList")for(const h of n.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&e(h)}).observe(document,{childList:!0,subtree:!0});function s(t){const n={};return t.integrity&&(n.integrity=t.integrity),t.referrerpolicy&&(n.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?n.credentials="include":t.crossorigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function e(t){if(t.ep)return;t.ep=!0;const n=s(t);fetch(t.href,n)}})();const u=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],r=(()=>{if(typeof document>"u")return!1;const l=u[0],i={};for(const s of u)if((s==null?void 0:s[1])in document){for(const[t,n]of s.entries())i[l[t]]=n;return i}return!1})(),d={change:r.fullscreenchange,error:r.fullscreenerror};let a={request(l=document.documentElement,i){return new Promise((s,e)=>{const t=()=>{a.off("change",t),s()};a.on("change",t);const n=l[r.requestFullscreen](i);n instanceof Promise&&n.then(t).catch(e)})},exit(){return new Promise((l,i)=>{if(!a.isFullscreen){l();return}const s=()=>{a.off("change",s),l()};a.on("change",s);const e=document[r.exitFullscreen]();e instanceof Promise&&e.then(s).catch(i)})},toggle(l,i){return a.isFullscreen?a.exit():a.request(l,i)},onchange(l){a.on("change",l)},onerror(l){a.on("error",l)},on(l,i){const s=d[l];s&&document.addEventListener(s,i,!1)},off(l,i){const s=d[l];s&&document.removeEventListener(s,i,!1)},raw:r};Object.defineProperties(a,{isFullscreen:{get:()=>Boolean(document[r.fullscreenElement])},element:{enumerable:!0,get:()=>document[r.fullscreenElement]??void 0},isEnabled:{enumerable:!0,get:()=>Boolean(document[r.fullscreenEnabled])}});r||(a={isEnabled:!1});const o=a;class m{decimalMul(i,s){var e=0,t=i.toString(),n=s.toString();try{e+=t.split(".")[1].length}catch{}try{e+=n.split(".")[1].length}catch{}return Number(t.replace(".",""))*Number(n.replace(".",""))/Math.pow(10,e)}decimalDiv(i,s){var e=0,t=0,n,h=i.toString(),c=s.toString();try{h.split(".")[1]!==void 0&&(e=h.split(".")[1].length)}catch{}try{c.split(".")[1]!==void 0&&(t=c.split(".")[1].length)}catch{}return n=Math.pow(10,Math.max(e,t)),this.decimalMul(i,n)/this.decimalMul(s,n)}createHDCanvas(i,s){var t;let e=document.createElement("canvas");return e.width=i*this.pixelRatio,e.height=s*this.pixelRatio,e.style.width=`${i}px`,e.style.height=`${s}px`,(t=e.getContext("2d"))==null||t.setTransform(this.pixelRatio,0,0,this.pixelRatio,0,0),e}adapterLayout(){var e,t;this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.canvas.width=this.width*this.pixelRatio,this.canvas.height=this.height*this.pixelRatio,this.canvas.style.width=`${this.width}px`,this.canvas.style.height=`${this.height}px`,(e=this.canvas.getContext("2d"))==null||e.setTransform(this.pixelRatio,0,0,this.pixelRatio,0,0),this.videoWidth=this.width,this.videoHeight=parseInt(String(this.decimalDiv(this.imageHeight,this.decimalDiv(this.imageWidth,this.width)))),this.videoTop=parseInt(String(this.decimalDiv(this.height-this.videoHeight,2)));let i=this.width/3,s=Math.max(this.videoTop,30);this.statusCanvas.width=i*this.pixelRatio,this.statusCanvas.height=s*this.pixelRatio,this.statusCanvas.style.width=`${i}px`,this.statusCanvas.style.height=`${s}px`,(t=this.statusCanvas.getContext("2d"))==null||t.setTransform(this.pixelRatio,0,0,this.pixelRatio,0,0),this.statusCtx.fillStyle="#fff",this.statusFontSize=Math.max(this.statusCanvas.width/55,10)}constructor(i,s,e){if(this.title=e||"",this.pixelRatio=window.devicePixelRatio||1,this.el=i,!this.el.offsetWidth)throw new Error("el 宽度不能为 0");this.wsUrl=s,this.wsRecvAt=0,this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.el.className=this.el.className+" wip",this.el.childNodes.forEach(t=>{var n;(n=this.el)==null||n.removeChild(t)}),this.canvas=null,this.ctx=null,this.statusCanvas=null,this.status=null,this.btn=null,this.btnMax=null,this.canvas=this.createHDCanvas(this.width,this.height),this.canvas.className="wip-video",this.el.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this.btn=document.createElement("button"),this.btn.className="wip-btn",this.btn.onclick=()=>{var t;this.ws&&((t=this.btn)!=null&&t.className.includes("paused")?(this.btn.className=this.btn.className.replace(" paused",""),this.videoCanPlay=!0):(this.btn.className=this.btn.className+" paused",this.videoCanPlay=!1))},this.el.appendChild(this.btn),this.titleSpan=document.createElement("span"),this.titleSpan.className="wip-title",this.titleSpan.innerText=this.ws?this.title:"loading",this.el.appendChild(this.titleSpan),this.btnMax=document.createElement("a"),this.btnMax.className="wip-btn-max",this.btnMax.innerText="全屏",this.btnMax.onclick=()=>{this.fullscreen()},this.el.appendChild(this.btnMax),this.videoCanPlay=!0}initStatus(){this.statusCanvas=this.createHDCanvas(this.width/3,Math.max(this.videoTop,30)),this.statusCanvas.className="wip-status",this.el.appendChild(this.statusCanvas),this.statusCtx=this.statusCanvas.getContext("2d"),this.statusCtx.fillStyle="#fff",this.statusFontSize=Math.max(this.statusCanvas.width/55,10)}test(){for(let i=0;i<300;i++)new WebSocket(this.wsUrl)}start(){this.ws||(this.ws=new WebSocket(this.wsUrl),this.ws.onopen=()=>{this.wsStartAt=Math.round(Number(new Date)/1e3),this.titleSpan.innerText=this.title},this.ws.onmessage=i=>{let s=Math.round(Number(new Date)/1e3);if(this.videoCanPlay){let e=new Image;e.src=window.URL.createObjectURL(i.data),e.onload=()=>{this.videoWidth||(this.imageWidth=e.naturalWidth,this.imageHeight=e.naturalHeight,this.videoWidth=this.width,this.videoHeight=parseInt(String(this.decimalDiv(this.imageHeight,this.decimalDiv(this.imageWidth,this.width)))),this.videoTop=parseInt(String(this.decimalDiv(this.height-this.videoHeight,2))),this.initStatus()),e.setAttribute("width",this.videoWidth*this.pixelRatio+"px"),e.setAttribute("height",this.videoHeight*this.pixelRatio+"px"),this.ctx.drawImage(e,0,this.videoTop>0?this.videoTop:0,this.videoWidth,this.videoHeight)}}if(this.wsRecvAt>0&&s-this.wsRecvAt>=1&&this.statusCanvas){let e="",t=this.wsRecvAt-this.wsStartAt,n=t/3600>=1?parseInt(String(t/3600)):0;e=String(n<10?"0"+n:n)+":",t=t%3600;let h=t/60>=1?parseInt(String(t/60)):0;e=e+String(h<10?"0"+h:h)+":",t=t%60,e=e+(t<10?"0"+t:t),this.statusCtx.clearRect(0,0,this.statusCanvas.offsetWidth,this.statusCanvas.offsetHeight),this.statusCtx.font=this.statusFontSize+"px sans-serif",this.statusCtx.fillText(e,10*this.pixelRatio,this.videoTop-10,80*this.pixelRatio)}this.wsRecvAt=s},this.ws.onclose=i=>{console.log(i),this.ws=null,this.titleSpan.innerText="loading"},this.ws.onerror=i=>{console.log(i),this.ws=null,this.titleSpan.innerText="loading",setTimeout(()=>{this.start()},3e3)})}stop(){this.ws&&(this.ws.close(),this.ws=null)}fullscreen(){o.isEnabled&&(o.on("change",()=>{this.btnMax.innerText=o.isFullscreen?"退出":"全屏",this.adapterLayout()}),o.isFullscreen?o.exit():o.request(this.el))}}window.WsImagePlayer=m;
